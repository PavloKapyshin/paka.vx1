<?xml version="1.0" encoding="utf-8"?><feed xml:lang="en" xmlns="http://www.w3.org/2005/Atom"><title>Recent notes (Django) from py.93z.org</title><link href="http://py.93z.org/tags/django/" rel="alternate"></link><link href="http://py.93z.org/tags/django/feed/" rel="self"></link><id>http://py.93z.org/tags/django/</id><updated>2016-06-20T00:00:00+00:00</updated><author><name>py.93z.org</name></author><entry><title>Reproducible builds and django.utils.feedgenerator</title><link href="http://py.93z.org/notes/reproducible-builds-and-django.utils.feedgenerator/" rel="alternate"></link><updated>2016-06-20T00:00:00+00:00</updated><id>http://py.93z.org/notes/reproducible-builds-and-django.utils.feedgenerator/</id><summary type="html">&lt;p&gt;Recently I’ve been working towards making builds of this blog reproducible. My goal was to allow use of regular &lt;code&gt;diff&lt;/code&gt; for spotting differences between resulting files.&lt;/p&gt;&lt;p&gt;But there was a problem. &lt;a href="https://tools.ietf.org/html/rfc4287"&gt;Atom 1.0&lt;/a&gt; feeds (e.g., &lt;a href="/notes/feed/"&gt;/notes/feed/&lt;/a&gt;, &lt;a href="/tags/django/feed/"&gt;/tags/django/feed/&lt;/a&gt;) are generated with my fork of &lt;code&gt;django.utils.feedgenerator&lt;/code&gt;. Both original and fork use &lt;code&gt;xml.sax.saxutils.XMLGenerator&lt;/code&gt; (implementation of &lt;a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler"&gt;&lt;code&gt;ContentHandler&lt;/code&gt;&lt;/a&gt; interface) subclass called &lt;code&gt;SimplerXMLGenerator&lt;/code&gt; for XML generation, and both pass elements’ attributes into &lt;a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler.startElement"&gt;&lt;code&gt;startElement&lt;/code&gt;&lt;/a&gt; and &lt;a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler.startElementNS"&gt;&lt;code&gt;startElementNS&lt;/code&gt;&lt;/a&gt; as regular &lt;code&gt;dict&lt;/code&gt;s. This caused random ordering of XML elements’ attributes in resulting feeds: textually feeds were changing, while semantically they were not. Despite being inconvenient for my use case (when use of specialized tools for XML comparison is undesirable), such behavior is, according to &lt;a href="https://www.w3.org/TR/2008/REC-xml-20081126/#sec-starttags"&gt;specification&lt;/a&gt;, valid:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;Note that the order of attribute specifications in a start-tag or empty-element tag is not significant.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;So I decided to take advantage of that. Both &lt;code&gt;startElement&lt;/code&gt; and &lt;code&gt;startElementNS&lt;/code&gt; methods assume that &lt;code&gt;attrs&lt;/code&gt; argument is an object that behaves like mapping (see lines &lt;a href="https://hg.python.org/cpython/file/dfc57c66a670/Lib/xml/sax/saxutils.py#l170"&gt;170&lt;/a&gt; and &lt;a href="https://hg.python.org/cpython/file/dfc57c66a670/Lib/xml/sax/saxutils.py#l195"&gt;195&lt;/a&gt; of &lt;code&gt;Lib/xml/sax/saxutils.py&lt;/code&gt;). &lt;a href="https://docs.python.org/3.4/library/collections.html#collections.OrderedDict"&gt;&lt;code&gt;OrderedDict&lt;/code&gt;&lt;/a&gt; is a mapping (like &lt;code&gt;dict&lt;/code&gt; is), therefore it is possible to provide &lt;code&gt;attrs&lt;/code&gt; (attributes of XML element) as an instance of &lt;code&gt;OrderedDict&lt;/code&gt; to preserve order of attributes. Least intrusive change—it’s a fork, after all—is to override two mentioned methods and sort &lt;code&gt;attrs&lt;/code&gt; there (&lt;code&gt;_order_attrs&lt;/code&gt;) before passing to implementation of superclass (&lt;code&gt;XMLGenerator&lt;/code&gt;):&lt;/p&gt;&lt;pre&gt;&lt;code&gt;import operator
import collections
from xml.sax.saxutils import XMLGenerator


_order_attrs_key = operator.itemgetter(0)


def _order_attrs(attrs):
    return collections.OrderedDict(
        sorted(attrs.items(), key=_order_attrs_key))


class SimplerXMLGenerator(XMLGenerator):

    def startElement(self, name, attrs):
        return super().startElement(name, _order_attrs(attrs))

    def startElementNS(self, name, qname, attrs):
        return super().startElementNS(name, qname, _order_attrs(attrs))

    # ...here goes the rest (already present in feedgenerator)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That’s what I did. Now my blog engine does not randomly reorder attributes in feeds, and the latter are still perfectly valid XML :).&lt;/p&gt;</summary><category term="django"></category><category term="xml"></category></entry></feed>