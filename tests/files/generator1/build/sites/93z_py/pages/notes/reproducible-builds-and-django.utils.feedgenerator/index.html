<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Reproducible builds and django.utils.feedgenerator ← Notes ← py.93z.org</title><link rel="stylesheet" href="/s/styles.css"><link rel="alternate" type="application/atom+xml" href="/notes/feed/" title="Recent notes from py.93z.org"></head><body><div class="h"><ol class="h-bc"><li><a href="/" rel="home">py.93z.org</a></li><li class="last"><a href="/notes/">Notes</a></li></ol></div><div class="c"><div class="c-i"><div class="c-p"><h1>Reproducible builds and django.utils.feedgenerator</h1><div class="n-b"><p>Recently I’ve been working towards making builds of this blog reproducible. My goal was to allow use of regular <code>diff</code> for spotting differences between resulting files.</p><p>But there was a problem. <a href="https://tools.ietf.org/html/rfc4287">Atom 1.0</a> feeds (e.g., <a href="/notes/feed/">/notes/feed/</a>, <a href="/tags/django/feed/">/tags/django/feed/</a>) are generated with my fork of <code>django.utils.feedgenerator</code>. Both original and fork use <code>xml.sax.saxutils.XMLGenerator</code> (implementation of <a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler"><code>ContentHandler</code></a> interface) subclass called <code>SimplerXMLGenerator</code> for XML generation, and both pass elements’ attributes into <a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler.startElement"><code>startElement</code></a> and <a href="https://docs.python.org/3.4/library/xml.sax.handler.html#xml.sax.handler.ContentHandler.startElementNS"><code>startElementNS</code></a> as regular <code>dict</code>s. This caused random ordering of XML elements’ attributes in resulting feeds: textually feeds were changing, while semantically they were not. Despite being inconvenient for my use case (when use of specialized tools for XML comparison is undesirable), such behavior is, according to <a href="https://www.w3.org/TR/2008/REC-xml-20081126/#sec-starttags">specification</a>, valid:</p><blockquote><p>Note that the order of attribute specifications in a start-tag or empty-element tag is not significant.</p></blockquote><p>So I decided to take advantage of that. Both <code>startElement</code> and <code>startElementNS</code> methods assume that <code>attrs</code> argument is an object that behaves like mapping (see lines <a href="https://hg.python.org/cpython/file/dfc57c66a670/Lib/xml/sax/saxutils.py#l170">170</a> and <a href="https://hg.python.org/cpython/file/dfc57c66a670/Lib/xml/sax/saxutils.py#l195">195</a> of <code>Lib/xml/sax/saxutils.py</code>). <a href="https://docs.python.org/3.4/library/collections.html#collections.OrderedDict"><code>OrderedDict</code></a> is a mapping (like <code>dict</code> is), therefore it is possible to provide <code>attrs</code> (attributes of XML element) as an instance of <code>OrderedDict</code> to preserve order of attributes. Least intrusive change—it’s a fork, after all—is to override two mentioned methods and sort <code>attrs</code> there (<code>_order_attrs</code>) before passing to implementation of superclass (<code>XMLGenerator</code>):</p><pre><code>import operator
import collections
from xml.sax.saxutils import XMLGenerator


_order_attrs_key = operator.itemgetter(0)


def _order_attrs(attrs):
    return collections.OrderedDict(
        sorted(attrs.items(), key=_order_attrs_key))


class SimplerXMLGenerator(XMLGenerator):

    def startElement(self, name, attrs):
        return super().startElement(name, _order_attrs(attrs))

    def startElementNS(self, name, qname, attrs):
        return super().startElementNS(name, qname, _order_attrs(attrs))

    # ...here goes the rest (already present in feedgenerator)
</code></pre><p>That’s what I did. Now my blog engine does not randomly reorder attributes in feeds, and the latter are still perfectly valid XML :).</p></div></div><div class="c-s"><div class="c-s-s"><h6>Note metadata</h6><dl class="nm-l"><dt>Publication date</dt><dd>June 20, 2016</dd><dt>Tags</dt><dd><ol class="t-l"><li><a href="/tags/django/">Django</a></li><li><a href="/tags/xml/">XML</a></li></ol></dd></dl></div><div class="c-s-s"><h6>Sorting dictionaries</h6><ol class="n-l"><li class="a-o"><span class="a">Reproducible builds and django.utils.feedgenerator</span></li><li><a href="/notes/sort-dict-keys-by-values/">Sort dict’s keys by values</a></li></ol></div><div class="c-s-s"><h6>About</h6><p>This is “all things Python” blog &amp; I hope some notes are helpful.</p></div><div class="c-s-s"><h6>Recent notes</h6><ol class="n-l"><li><a href="/notes/automatic-html-escaping-in-mako/">Automatic &lt;HTML&gt; escaping in Mako</a></li><li><a href="/notes/how-to-create-.tar.gz-reproducibly/">How to create .tar.gz reproducibly (putting it together)</a></li><li><a href="/notes/how-to-create-.gz-reproducibly/">How to create .gz reproducibly</a></li><li><a href="/notes/how-to-create-.tar-reproducibly/">How to create .tar reproducibly</a></li><li class="a-o"><span class="a">Reproducible builds and django.utils.feedgenerator</span></li><li><a href="/notes/how-to-determine-file-where-particular-function-is-defined/">How to determine file where particular function is defined</a></li><li><a href="/notes/python-m-compatibility/">python -m compatibility</a></li><li><a href="/notes/sort-dict-keys-by-values/">Sort dict’s keys by values</a></li></ol><p><a href="/notes/">All notes</a></p></div></div></div></div><div class="f"><div class="f-i"><div class="f-a"><p>© 2010–2017 py.93z.org</p></div><div class="f-s"><ol class="f-nw"><li><a href="//dev.93z.org">dev.93z.org</a></li><li class="a-o"><a href="/" rel="home" class="a">py.93z.org</a></li></ol></div></div></div><script src="/s/scripts.js" type="text/javascript"></script></body></html>